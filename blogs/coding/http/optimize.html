<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>真牛英雄 | http请求的tcp瓶颈</title>
    <meta name="description" content="看啥看">
    
    
    <link rel="preload" href="/assets/css/36.styles.557faed4.css" as="style"><link rel="preload" href="/assets/js/app.8261995b.js" as="script"><link rel="preload" href="/assets/js/22.7b518bea.js" as="script"><link rel="prefetch" href="/assets/js/12.2dd19f95.js"><link rel="prefetch" href="/assets/js/0.2473a6f7.js"><link rel="prefetch" href="/assets/js/1.5ea79099.js"><link rel="prefetch" href="/assets/js/2.2b7f92b9.js"><link rel="prefetch" href="/assets/js/3.c35ac125.js"><link rel="prefetch" href="/assets/js/4.33745bd7.js"><link rel="prefetch" href="/assets/js/5.d9114106.js"><link rel="prefetch" href="/assets/js/6.9e328d79.js"><link rel="prefetch" href="/assets/js/7.5d3d1168.js"><link rel="prefetch" href="/assets/js/8.98d7c36f.js"><link rel="prefetch" href="/assets/js/9.575dad7c.js"><link rel="prefetch" href="/assets/js/10.052aa6a7.js"><link rel="prefetch" href="/assets/js/11.2bda47c3.js"><link rel="prefetch" href="/assets/js/13.ba47ffda.js"><link rel="prefetch" href="/assets/js/14.ef016eda.js"><link rel="prefetch" href="/assets/js/15.463b3f5a.js"><link rel="prefetch" href="/assets/js/16.92ba4283.js"><link rel="prefetch" href="/assets/js/17.0066a01b.js"><link rel="prefetch" href="/assets/js/18.faf31784.js"><link rel="prefetch" href="/assets/js/19.115165dc.js"><link rel="prefetch" href="/assets/js/20.8e4255e1.js"><link rel="prefetch" href="/assets/js/21.5bd4f746.js"><link rel="prefetch" href="/assets/js/23.48cf48d2.js"><link rel="prefetch" href="/assets/js/24.e80a0c2b.js"><link rel="prefetch" href="/assets/js/25.9620f9e6.js"><link rel="prefetch" href="/assets/js/26.c698f17b.js"><link rel="prefetch" href="/assets/js/27.f26b39ac.js"><link rel="prefetch" href="/assets/js/28.eed975fe.js"><link rel="prefetch" href="/assets/js/29.528313a0.js"><link rel="prefetch" href="/assets/js/30.b2c14d8a.js"><link rel="prefetch" href="/assets/js/31.0ded6227.js"><link rel="prefetch" href="/assets/js/32.d7376006.js"><link rel="prefetch" href="/assets/js/33.e735fef4.js"><link rel="prefetch" href="/assets/js/34.3ed1ff17.js"><link rel="prefetch" href="/assets/js/35.6d8f8c9b.js">
    <link rel="stylesheet" href="/assets/css/36.styles.557faed4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      真牛英雄
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/blogs/coding/other/linux.html" class="nav-link">代码</a></div><div class="nav-item"><a href="/blogs/bodybuilding/tmf.html" class="nav-link">健身</a></div><div class="nav-item"><a href="/blogs/gameing/" class="nav-link">游戏</a></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/blogs/coding/other/linux.html" class="nav-link">代码</a></div><div class="nav-item"><a href="/blogs/bodybuilding/tmf.html" class="nav-link">健身</a></div><div class="nav-item"><a href="/blogs/gameing/" class="nav-link">游戏</a></div><!----></nav><ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>区块链</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>其他</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>Http</span><span class="arrow down"></span></p><ul class="sidebar-group-items"><li><a href="/blogs/coding/http/https.html" class="sidebar-link">https</a></li><li><a href="/blogs/coding/http/http2.0.html" class="sidebar-link">http2.0</a></li><li><a href="/blogs/coding/http/handshake.html" class="sidebar-link">http的三次握手</a></li><li><a href="/blogs/coding/http/optimize.html" class="active sidebar-link">http请求的tcp瓶颈</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blogs/coding/http/optimize.html#三次握手" class="sidebar-link">三次握手</a></li><li class="sidebar-sub-header"><a href="/blogs/coding/http/optimize.html#流量控制-接收窗口" class="sidebar-link">流量控制(接收窗口)</a></li><li class="sidebar-sub-header"><a href="/blogs/coding/http/optimize.html#慢启动-cwnd-拥塞窗口" class="sidebar-link">慢启动(cwnd,拥塞窗口)</a></li><li class="sidebar-sub-header"><a href="/blogs/coding/http/optimize.html#队首阻塞" class="sidebar-link">队首阻塞</a></li><li class="sidebar-sub-header"><a href="/blogs/coding/http/optimize.html#性能调优" class="sidebar-link">性能调优</a></li></ul></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>JavaScript学习</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>NodeJs学习</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>CSS学习</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Vue源码学习</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>React学习</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>docker学习</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Java学习</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Spring学习</span><span class="arrow right"></span></p><!----></div></li></ul></div><div class="page"><div class="content"><h1 id="瓶颈"><a href="#瓶颈" aria-hidden="true" class="header-anchor">#</a> 瓶颈</h1><p></p><div class="table-of-contents"><ul><li><a href="#三次握手">三次握手</a></li><li><a href="#流量控制-接收窗口">流量控制(接收窗口)</a></li><li><a href="#慢启动-cwnd-拥塞窗口">慢启动(cwnd,拥塞窗口)</a><ul><li><a href="#慢启动的影响">慢启动的影响</a></li></ul></li><li><a href="#队首阻塞">队首阻塞</a></li><li><a href="#性能调优">性能调优</a><ul><li><a href="#服务器配置调优">服务器配置调优</a></li><li><a href="#应用程序调优">应用程序调优</a></li></ul></li></ul></div><p></p><h2 id="三次握手"><a href="#三次握手" aria-hidden="true" class="header-anchor">#</a> 三次握手</h2><p><img src="/assets/img/handshake.111ed364.png" alt="三次握手"></p><p>客户端可以在发送 ACK分组之后立即发送数据,而服务器必须等接收到ACK分组之后才能发送数据。这个启动通信的过程适用于所有 TCP 连接,因此对所有使用TCP的应用具有非常大的性能影响,<strong>每次传输应用数据之前,都必须经历一次完整的往返</strong></p><h2 id="流量控制-接收窗口"><a href="#流量控制-接收窗口" aria-hidden="true" class="header-anchor">#</a> 流量控制(接收窗口)</h2><p>rwnd是端到端的控制机制，预防发送过多的数据,TCP连接的每一方都会通告自己的接收窗口,其中包含能够保存数据的缓冲区空间大小信息。TCP 连接的整个生命周期:每个 ACK 分组都会携带相应的最新rwnd 值,以便两端动态调整数据流速,使之适应发送端和接收端的容量及处理能力</p><p>窗口的值原来只有16位，即65535，所以以前rwnd的最大值不能超过64K。现在基本都有了“TCP 窗口缩放”(TCP Window Scaling)，把接收窗口大小由 65 535 字节提高到 1G 字节，在 Linux 中,可以通过如下命 令检查和启用窗口缩放选项:</p><pre class="language-bash"><code>sysctl net.ipv4.tcp_window_scaling $<span class="token operator">&gt;</span> sysctl -w net.ipv4.tcp_window_scaling<span class="token operator">=</span>1
</code></pre><h2 id="慢启动-cwnd-拥塞窗口"><a href="#慢启动-cwnd-拥塞窗口" aria-hidden="true" class="header-anchor">#</a> 慢启动(cwnd,拥塞窗口)</h2><p>两端流量控制确实可以防止发送端向接收端过多发送数据,但却没有机制预防任何一端向潜在网络过多发送数据。换句话说,发送端和接收端在连接建立之初,谁也不知道可用带宽是多少,因此需要一个估算机制,<strong>然后根据网络中不断变化的条件 而动态改变速度:TCP能传输的最大数据 = MIN（rand,cwnd）</strong></p><h3 id="慢启动的影响"><a href="#慢启动的影响" aria-hidden="true" class="header-anchor">#</a> 慢启动的影响</h3><p>无论带宽多大,每个 TCP 连接都必须经过慢 启动阶段。换句话说,我们不可能一上来就完全利用连接的最大带宽。</p><p>慢启动导致客户端与服务器之间经过几百 ms 才能达到接近最大速度的问题,对于大型流式下载服务的影响不显著,因为慢启动的时间可以分摊到整个传输周期内消化掉。</p><h2 id="队首阻塞"><a href="#队首阻塞" aria-hidden="true" class="header-anchor">#</a> 队首阻塞</h2><p>每个 TCP 分组都会带着一个唯一的序列号被发出,而 所有分组必须按顺序传送到接收端。如果中途有一个分组没能到达接收端,那么后续分组必须保存在接收端的TCP缓冲区,等待丢失的分组重发并到达接收端。这一切都发生在TCP层,应用程序对TCP重发和缓冲区中排队的分组一无所知,必须等待分组全部到达才能访问数据。在此之前,应用程序只能在通过套接字读数据时感觉到延迟交付。这种效应称为TCP的队首(HOL,Head of Line)阻塞</p><div class="tip custom-block"><p class="custom-block-title">结果</p><p>现代高速网络中 TCP 连接的数据传输速度,往往会受到接收端和发送端之 间往返时间的限制。另外,尽管带宽不断增长,但延迟依旧受限于光速,而且已经 限定在了其最大值的一个很小的常数因子之内。大多数情况下,TCP 的瓶颈都是延迟,而非带宽</p></div><h2 id="性能调优"><a href="#性能调优" aria-hidden="true" class="header-anchor">#</a> 性能调优</h2><h3 id="服务器配置调优"><a href="#服务器配置调优" aria-hidden="true" class="header-anchor">#</a> 服务器配置调优</h3><ul><li><p>增大TCP的初始拥塞窗口
加大起始拥塞窗口可以让 TCP 在第一次往返就传输较多数据,而随后的速度提 升也会很明显。对于突发性的短暂连接,这也是特别关键的一个优化。</p></li><li><p>慢启动重启
在连接空闲时禁用慢启动可以改善瞬时发送数据的长 TCP 连接的性能。</p></li><li><p>窗口缩放(RFC 1323)
启用窗口缩放可以增大最大接收窗口大小,可以让高延迟的连接达到更好吞 吐量。</p></li><li><p>TCP快速打开
在某些条件下,允许在第一个 SYN 分组中发送应用程序数据。TFO(TCP Fast Open,TCP 快速打开)是一种新的优化选项,需要客户端和服务器共同支持。 为此,首先要搞清楚你的应用程序是否可以利用这个特性。</p></li></ul><p>以上几个设置再加上最新的内核,可以确保最佳性能:每个 TCP 连接都会具有较低 的延迟和较高的吞吐量。</p><h3 id="应用程序调优"><a href="#应用程序调优" aria-hidden="true" class="header-anchor">#</a> 应用程序调优</h3><ul><li><p>再快也快不过什么也不用发送,能少发就少发。</p></li><li><p>我们不能让数据传输得更快,但可以让它们传输的距离更短。</p></li><li><p>重用 TCP 连接是提升性能的关键</p></li></ul></div><!----><div class="content page-nav"><p class="inner"><span class="prev">
        ← <a href="/blogs/coding/http/handshake.html" class="prev">
          http的三次握手
        </a></span><span class="next"><a href="/blogs/coding/javascript/eventloop.html">
          JS的事件循环机制
        </a> →
      </span></p></div></div></div></div>
    <script src="/assets/js/22.7b518bea.js" defer></script><script src="/assets/js/app.8261995b.js" defer></script>
  </body>
</html>
