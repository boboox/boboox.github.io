<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>真牛英雄 | 源码阅读(二)Vue响应式原理</title>
    <meta name="description" content="看啥看">
    
    
    <link rel="preload" href="/assets/css/37.styles.c10b3e63.css" as="style"><link rel="preload" href="/assets/js/app.de304580.js" as="script"><link rel="preload" href="/assets/js/2.6e3d5767.js" as="script"><link rel="prefetch" href="/assets/js/10.dd587740.js"><link rel="prefetch" href="/assets/js/0.edfd7b42.js"><link rel="prefetch" href="/assets/js/1.db13ac2e.js"><link rel="prefetch" href="/assets/js/3.f72df505.js"><link rel="prefetch" href="/assets/js/4.15e4d33f.js"><link rel="prefetch" href="/assets/js/5.37f2fcbd.js"><link rel="prefetch" href="/assets/js/6.12cc404e.js"><link rel="prefetch" href="/assets/js/7.8b85edfd.js"><link rel="prefetch" href="/assets/js/8.1a03e92f.js"><link rel="prefetch" href="/assets/js/9.17071777.js"><link rel="prefetch" href="/assets/js/11.9916a06e.js"><link rel="prefetch" href="/assets/js/12.5d48726c.js"><link rel="prefetch" href="/assets/js/13.dcb82be7.js"><link rel="prefetch" href="/assets/js/14.05016b97.js"><link rel="prefetch" href="/assets/js/15.e884cf02.js"><link rel="prefetch" href="/assets/js/16.d31c56e0.js"><link rel="prefetch" href="/assets/js/17.b318e07d.js"><link rel="prefetch" href="/assets/js/18.0a374358.js"><link rel="prefetch" href="/assets/js/19.9313a7a0.js"><link rel="prefetch" href="/assets/js/20.56cb6d1d.js"><link rel="prefetch" href="/assets/js/21.737ec51a.js"><link rel="prefetch" href="/assets/js/22.10e8d627.js"><link rel="prefetch" href="/assets/js/23.ea8ab115.js"><link rel="prefetch" href="/assets/js/24.32698286.js"><link rel="prefetch" href="/assets/js/25.c6220d17.js"><link rel="prefetch" href="/assets/js/26.b0e2c191.js"><link rel="prefetch" href="/assets/js/27.ad9db46a.js"><link rel="prefetch" href="/assets/js/28.42479c2e.js"><link rel="prefetch" href="/assets/js/29.d0556fa8.js"><link rel="prefetch" href="/assets/js/30.0df72cc2.js"><link rel="prefetch" href="/assets/js/31.1fc0335a.js"><link rel="prefetch" href="/assets/js/32.622253fe.js"><link rel="prefetch" href="/assets/js/33.076f6c20.js"><link rel="prefetch" href="/assets/js/34.84540417.js"><link rel="prefetch" href="/assets/js/35.93ad9081.js"><link rel="prefetch" href="/assets/js/36.c6df11bd.js">
    <link rel="stylesheet" href="/assets/css/37.styles.c10b3e63.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      真牛英雄
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/blogs/coding/other/linux.html" class="nav-link">代码</a></div><div class="nav-item"><a href="/blogs/bodybuilding/tmf.html" class="nav-link">健身</a></div><div class="nav-item"><a href="/blogs/gameing/" class="nav-link">游戏</a></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/blogs/coding/other/linux.html" class="nav-link">代码</a></div><div class="nav-item"><a href="/blogs/bodybuilding/tmf.html" class="nav-link">健身</a></div><div class="nav-item"><a href="/blogs/gameing/" class="nav-link">游戏</a></div><!----></nav><ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>区块链</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>其他</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Http</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>JavaScript学习</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>NodeJs学习</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>CSS学习</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>Vue源码学习</span><span class="arrow down"></span></p><ul class="sidebar-group-items"><li><a href="/blogs/coding/vue/vue-source-init.html" class="sidebar-link">源码阅读(一)Vue初始化</a></li><li><a href="/blogs/coding/vue/vue-source-data.html" class="active sidebar-link">源码阅读(二)Vue响应式原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blogs/coding/vue/vue-source-data.html#从数据代理开始" class="sidebar-link">从数据代理开始</a></li><li class="sidebar-sub-header"><a href="/blogs/coding/vue/vue-source-data.html#深入响应式" class="sidebar-link">深入响应式</a></li><li class="sidebar-sub-header"><a href="/blogs/coding/vue/vue-source-data.html#画图" class="sidebar-link">画图!</a></li></ul></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>React学习</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>docker学习</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Java学习</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Spring学习</span><span class="arrow right"></span></p><!----></div></li></ul></div><div class="page"><div class="content"><h1 id="源码阅读-二-vue响应式原理"><a href="#源码阅读-二-vue响应式原理" aria-hidden="true" class="header-anchor">#</a> 源码阅读(二) Vue响应式原理</h1><p></p><div class="table-of-contents"><ul><li><a href="#从数据代理开始">从数据代理开始</a><ul><li><a href="#第一个关键代码">第一个关键代码</a></li><li><a href="#第二个关键代码">第二个关键代码</a></li></ul></li><li><a href="#深入响应式">深入响应式</a><ul><li><a href="#data的响应式">data的响应式</a></li><li><a href="#computed的响应式">computed的响应式</a></li></ul></li><li><a href="#画图">画图!</a></li></ul></div><p></p><h2 id="从数据代理开始"><a href="#从数据代理开始" aria-hidden="true" class="header-anchor">#</a> 从数据代理开始</h2><p>在上一篇<a href="/blogs/coding/vue/vue-source-init.html">源码阅读(一)Vue初始化</a>中主要介绍了init整个过程中执行的几个主要方法,
而建立响应式系统的关键就是initState方法</p><pre class="language-js"><code><span class="token comment">// Vue-source/src/core/instance/state.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initState</span><span class="token punctuation">(</span>vm<span class="token punctuation">:</span> Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  vm<span class="token punctuation">.</span>_watchers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> opts <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token function">initProps</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>props<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>methods<span class="token punctuation">)</span> <span class="token function">initMethods</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>methods<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">initData</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">observe</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* asRootData */</span> <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>computed<span class="token punctuation">)</span> <span class="token function">initComputed</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>computed<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>watch <span class="token operator">&amp;&amp;</span> opts<span class="token punctuation">.</span>watch <span class="token operator">!==</span> nativeWatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">initWatch</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>watch<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>接上一篇的例子中,我们只传入了
<code>data</code>与<code>computed</code>
所以只会执行两个方法,<code>initData</code>与<code>initComputed</code></p><p>关键代码如下:</p><pre class="language-js"><code><span class="token comment">// Vue-source/src/core/instance/state.js</span>
<span class="token keyword">function</span> <span class="token function">initData</span><span class="token punctuation">(</span>vm<span class="token punctuation">:</span> Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>data
  <span class="token comment">// 当data类型是function的时候,应该是一个getter函数,所以需要data.call(vm)???</span>
  data <span class="token operator">=</span> vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token keyword">typeof</span> data <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span>
    <span class="token function">getData</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> vm<span class="token punctuation">)</span> <span class="token punctuation">:</span>
    data <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token operator">...</span>
  <span class="token comment">// proxy data on instance</span>
  <span class="token function">proxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`_data`</span></span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token operator">...</span>
  <span class="token comment">// observe data</span>
  <span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* asRootData */</span> <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="第一个关键代码"><a href="#第一个关键代码" aria-hidden="true" class="header-anchor">#</a> 第一个关键代码</h3><pre class="language-js"><code>data <span class="token operator">=</span> vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token keyword">typeof</span> data <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">getData</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> vm<span class="token punctuation">)</span> <span class="token punctuation">:</span> data <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><p>如果<code>data</code>是一个函数的时候,调用<code>getData</code>方法,从实例上面计算<code>data</code>的值,</p><p>否则直接发返回<code>data</code></p><div class="tip custom-block"><p class="custom-block-title">划重点</p><p>看到这里就明白了官网的<strong>Data must be a Function</strong></p></div><p>如果<code>data</code>不是function则Vue做为一个组件的时候,同一个组件的多个实例将共享同一个<code>data</code></p><p>注意:这里同时将<code>data</code>赋值给了<code>vm._data</code></p><h3 id="第二个关键代码"><a href="#第二个关键代码" aria-hidden="true" class="header-anchor">#</a> 第二个关键代码</h3><pre class="language-js"><code><span class="token function">proxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`_data`</span></span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
</code></pre><p><code>proxy</code>方法的作用是在实例<code>this/vm</code>上面做了一次<code>data</code>的数据代理,只有如此我们才可以通过<code>this.a</code> 来访问<code>data.a</code>
这里的this就是vm</p><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">:</span> Object<span class="token punctuation">,</span> sourceKey<span class="token punctuation">:</span> string<span class="token punctuation">,</span> key<span class="token punctuation">:</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sharedPropertyDefinition<span class="token punctuation">.</span><span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">proxyGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span>sourceKey<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    sharedPropertyDefinition<span class="token punctuation">.</span><span class="token function-variable function">set</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">proxySetter</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">[</span>sourceKey<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val
    <span class="token punctuation">}</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> sharedPropertyDefinition<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>结果就是通过<code>ES5 Object.defineProperty</code>方法在<code>vm</code>上的定义了两个<code>a,b</code>属性,而其<code>getter/setter</code>方法为</p><pre class="language-js"><code><span class="token keyword">const</span> sharedPropertyDefinition <span class="token operator">=</span> <span class="token punctuation">{</span>
    enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">proxyGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span>_data<span class="token punctuation">]</span><span class="token punctuation">[</span>a<span class="token operator">/</span>b<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">proxySetter</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">[</span>_data<span class="token punctuation">]</span><span class="token punctuation">[</span>a<span class="token operator">/</span>b<span class="token punctuation">]</span> <span class="token operator">=</span> val
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>从此可以看出当我们在实例上访问属性<code>this.a</code>的时候,实际上他的访问路径是
this.a==&gt;vm.a==&gt;<strong>vm._data.a</strong>==&gt;$option.data.a
至此,就完成了Vue的数据代理</p><h2 id="深入响应式"><a href="#深入响应式" aria-hidden="true" class="header-anchor">#</a> 深入响应式</h2><h3 id="data的响应式"><a href="#data的响应式" aria-hidden="true" class="header-anchor">#</a> data的响应式</h3><p>关键方法</p><pre class="language-js"><code><span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* asRootData */</span> <span class="token punctuation">)</span>
</code></pre><p>这是整个响应式的入口</p><p><code>observe</code>方法只做了一件事情,就是<code>new Observer(data)</code></p><p>建立了一个观察者</p><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>
  value<span class="token punctuation">:</span> any<span class="token punctuation">;</span>
  dep<span class="token punctuation">:</span> Dep<span class="token punctuation">;</span>
  vmCount<span class="token punctuation">:</span> number<span class="token punctuation">;</span> <span class="token comment">// number of vms that has this object as root $data</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> any<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value
    <span class="token keyword">this</span><span class="token punctuation">.</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vmCount <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token function">def</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">'__ob__'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="highlighted-line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span></span>  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * Walk through each property and convert them into
   * getter/setters. This method should only be called when
   * value type is Object.
   */</span>
  <span class="token function">walk</span><span class="token punctuation">(</span>obj<span class="token punctuation">:</span> Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="highlighted-line">      <span class="token function">defineReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> obj<span class="token punctuation">[</span>keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>源码可以看出其实实例化一个<code>Observer</code>最终就是遍历<code>data</code>的所有属性
并对其调用<code>defineReactive</code>方法</p><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">:</span> Object<span class="token punctuation">,</span>key<span class="token punctuation">:</span> string<span class="token punctuation">,</span>val<span class="token punctuation">:</span> any<span class="token punctuation">,</span>customSetter <span class="token operator">?</span> <span class="token punctuation">:</span> <span class="token operator">?</span> Function<span class="token punctuation">,</span>shallow <span class="token operator">?</span> <span class="token punctuation">:</span> boolean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 每一个响应式的属性都有持有一个依赖Dep</span>
  <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">reactiveGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	  <span class="token comment">// 计算data的值</span>
      <span class="token keyword">const</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> getter<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">:</span> 
	  <span class="token comment">// 直接访问data的时候Dep.target是空的</span>
	  <span class="token comment">// 这里的用处后面讲</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="highlighted-line">        dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> value
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">reactiveSetter</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> getter<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">:</span> val
      <span class="token comment">// 如果新旧得值没有方法变化则直接返回</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newVal <span class="token operator">===</span> value <span class="token operator">||</span> <span class="token punctuation">(</span>newVal <span class="token operator">!==</span> newVal <span class="token operator">&amp;&amp;</span> value <span class="token operator">!==</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
	  <span class="token comment">// 调用setter</span>
      setter<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span>
	  <span class="token comment">// 通过dep的notify发出通知,来执行dom的刷新等操作</span>
<span class="highlighted-line">      dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>通过<code>defineReactive</code>这个方法<code>data</code>对的属性的响应式系统就已经建立起来了
其中有一个关键的对象
<code>const dep = new Dep()</code>
起着依赖收集的作用,它的作用稍后展开,</p><p>到此为止<code>data</code>的a,b两个属性已经完成了响应式系统的建立,通过修改属性就可以出发依赖的通知去做相应的修改
但是,对于<code>computed</code>属性
整个过程并不一样</p><h3 id="computed的响应式"><a href="#computed的响应式" aria-hidden="true" class="header-anchor">#</a> computed的响应式</h3><p>回到<code>initState</code>函数中,可以看到<code>computed</code>属性会调用<code>initComputed</code>方法</p><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">initComputed</span><span class="token punctuation">(</span>vm<span class="token punctuation">:</span> Component<span class="token punctuation">,</span> computed<span class="token punctuation">:</span> Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> watchers <span class="token operator">=</span> vm<span class="token punctuation">.</span>_computedWatchers <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> computed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 	<span class="token keyword">const</span> userDef <span class="token operator">=</span> computed<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">let</span> getter <span class="token operator">=</span> <span class="token keyword">typeof</span> userDef <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> userDef <span class="token punctuation">:</span> userDef<span class="token punctuation">.</span><span class="token keyword">get</span>
    <span class="token comment">// create internal watcher for the computed property.</span>
    watchers<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> getter<span class="token punctuation">,</span> noop<span class="token punctuation">,</span> computedWatcherOptions<span class="token punctuation">)</span>
    <span class="token comment">// component-defined computed properties are already defined on the</span>
    <span class="token comment">// component prototype. We only need to define computed properties defined</span>
    <span class="token comment">// at instantiation here.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> vm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">defineComputed</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> userDef<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>该方法为每一个<code>computed</code>属性实例化了一个<code>Watcher</code>
直接看一下<code>Watcher</code>构造函数的源码</p><pre class="language-js"><code><span class="token comment">/* Watcher的构造函数 */</span>
<span class="token function">constructor</span><span class="token punctuation">(</span>vm<span class="token punctuation">:</span> Component<span class="token punctuation">,</span> expOrFn<span class="token punctuation">:</span> string <span class="token operator">|</span> Function<span class="token punctuation">,</span> cb<span class="token punctuation">:</span> Function<span class="token punctuation">,</span> options <span class="token operator">?</span> <span class="token punctuation">:</span> Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm
  vm<span class="token punctuation">.</span>_watchers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token operator">...</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb
  <span class="token keyword">this</span><span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>depIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token operator">...</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> <span class="token function">parsePath</span><span class="token punctuation">(</span>expOrFn<span class="token punctuation">)</span>
  <span class="token operator">...</span>
<span class="highlighted-line">  <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token operator">?</span> undefined <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
<span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Dep.target = this</span>
  <span class="token function">pushTarget</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> value
  <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm
  value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>getter<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
  <span class="token comment">// Dep.target = null ... </span>
  <span class="token function">popTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cleanupDeps</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> value
<span class="token punctuation">}</span>
</code></pre><p><code>Watcher</code>定义了一些<code>Dep</code>的集合用于收集<code>reactive data</code>的<code>dep</code></p><div class="tip custom-block"><p class="custom-block-title">划重点</p><p>在完成初始化的最后,执行了<code>this.get()</code></p></div><p>在<code>get</code>方法中三个关键的步骤</p><ol><li><p>pushTarget(this)</p><p><code>pushTarget</code>方法将当前<code>Watcher</code>设置为<code>Dep.target</code>(全局唯一)</p></li><li><p>this.getter.call</p><p>在例子中,该方法就是</p><pre class="language-js"><code><span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token operator">+</span><span class="token keyword">this</span><span class="token punctuation">.</span>b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>调用该方法会触发a,b属性的<code>getter</code>方法,这时候我们可以回到<code>data</code>的响应式中<code>data</code>的<code>getter</code>方法中那一段函数和其相关联的函数</p><pre class="language-js"><code><span class="token comment">/*这段在data的get方法中,进行依赖收集*/</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">{</span>
    dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><pre class="language-js"><code><span class="token comment">/* Dep.depend 方法,target 就是computed实例化的watcher,也就是调用了watcher.addDep()*/</span>
<span class="token function">depend</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Dep<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">addDep</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><pre class="language-js"><code><span class="token comment">/* watcher.addDep 方法,将自己添加到传入的dep实例的sub中去 */</span>
<span class="token function">addDep</span> <span class="token punctuation">(</span>dep<span class="token punctuation">:</span> Dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> dep<span class="token punctuation">.</span>id
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/*watcher持有了相关的dep*/</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>depIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/*dep持有了Watcher*/</span>
            dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><pre class="language-js"><code><span class="token comment">/* Dep.addSub方法就是让dep持有了watcher*/</span>
<span class="token function">addSub</span> <span class="token punctuation">(</span>sub<span class="token punctuation">:</span>Watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>整个过程就是</p><ul><li>=&gt; data.a</li><li>=&gt; a.getter()</li><li>=&gt; dep.depend()</li><li>=&gt; <strong>Dep的target(即Watcher).addDep()</strong></li><li>=&gt; Watcher持有了Dep</li><li>=&gt; <strong>又在Watcher触发了Dep的addSub()</strong></li><li>=&gt; addSub中Dep也持有了Watcher</li></ul><p>到这里为止,通过<code>Observer</code>的<code>defineReactive</code>建立的getter</p><p>让<code>Dep</code>和<code>Watcher</code>相互持有</p><p>所以在之后我们修改data的值的时候会触发<code>data.setter</code>中的<code>dep.notify()</code>
而此时<code>dep</code>已经持有了<code>watcher</code>,便可以通知<code>watcher</code>去刷新它的值</p></li><li><p>popTarget</p><p>因为Dep.target并不是一个实例数据,他是Dep函数的静态属性,</p><p>在Dep实例每次收益依赖的时候,收集的都是Dep当前的<code>target</code>(即Watcher)</p><p>所以在每次调用get计算的之前会<code>pushTarget()</code>收当前的<code>Watcher</code>,</p><p>完成取值之后</p><p>还原<code>Dep.target</code></p><p>就需要调用<code>pushTarget()</code></p></li></ol><h2 id="画图"><a href="#画图" aria-hidden="true" class="header-anchor">#</a> 画图!</h2><p>Vue的init过程(图)
<img src="/assets/img/vue-source-data-1.7f535c31.png" alt="Vue的init过程">
Vue的响应式系统(图)
<img src="/assets/img/vue-source-data-2.e6dbe563.png" alt="Vue的响应式系统"></p></div><!----><div class="content page-nav"><p class="inner"><span class="prev">
        ← <a href="/blogs/coding/vue/vue-source-init.html" class="prev">
          源码阅读(一)Vue初始化
        </a></span><span class="next"><a href="/blogs/coding/react/react-tutorial.html">
          React入门教程
        </a> →
      </span></p></div></div></div></div>
    <script src="/assets/js/2.6e3d5767.js" defer></script><script src="/assets/js/app.de304580.js" defer></script>
  </body>
</html>
