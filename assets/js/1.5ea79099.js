(window.webpackJsonp=window.webpackJsonp||[]).push([[1],{97:function(t,s,n){"use strict";n.r(s);var a=n(0),e=Object(a.a)({},function(){this.$createElement;this._self._c;return this._m(0)},[function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"content"},[n("h1",{attrs:{id:"源码阅读-一-vue初始化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#源码阅读-一-vue初始化","aria-hidden":"true"}},[t._v("#")]),t._v(" 源码阅读(一) Vue初始化")]),n("p"),n("div",{staticClass:"table-of-contents"},[n("ul",[n("li",[n("a",{attrs:{href:"#从入口开始"}},[t._v("从入口开始")])]),n("li",[n("a",{attrs:{href:"#vue对象的实例化-new-vue"}},[t._v("Vue对象的实例化 new Vue()")])]),n("li",[n("a",{attrs:{href:"#实例化的参数-options"}},[t._v("实例化的参数 Options")])]),n("li",[n("a",{attrs:{href:"#初始化函数-this-init"}},[t._v("初始化函数 this._init()")])])])]),n("p"),n("h2",{attrs:{id:"从入口开始"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#从入口开始","aria-hidden":"true"}},[t._v("#")]),t._v(" 从入口开始")]),n("ol",[n("li",[t._v("build/config.js\n从打包的配置文件开始,找到文件入口")]),n("li",[t._v("web/entry-runtime.js")]),n("li",[t._v("web/runtime/index.js\n"),n("ul",[n("li",[t._v("为Vue添加了实例方法$mount\n"),n("ul",[n("li",[t._v("query(el)")]),n("li",[t._v("mountComponent(...)")])])])])]),n("li",[t._v("core/index.js\n"),n("ul",[n("li",[t._v("initGlobalAPI(Vue)"),n("div",{staticClass:"tip custom-block"},[n("p",{staticClass:"custom-block-title"},[t._v("注意")]),n("p",[t._v("Vue 下的静态属性和方法的挂载主要是在 src/core/global-api 目录下的代码处理的")])])]),n("li",[t._v("为Vue添加了只读属性$isServer,$ssrContext")])])]),n("li",[t._v("core/instance/index.js\n"),n("ul",[n("li",[t._v("定义了Vue构造函数"),n("div",{staticClass:"tip custom-block"},[n("p",{staticClass:"custom-block-title"},[t._v("注意")]),n("p",[t._v("Vue.prototype 下的属性和方法的挂载主要是在 src/core/instance 目录中的代码处理的")])])]),n("li",[t._v("initMixin\n"),n("ul",[n("li",[t._v("调用五个方法:,       在prototype上添加了_init方法\ninit方法中添加了$options属性\n"),n("ul",[n("li",[t._v("parent")]),n("li",[t._v("propsData")]),n("li",[t._v("_parentVnode")]),n("li",[t._v("_parentListeners")]),n("li",[t._v("_renderChildren")]),n("li",[t._v("_componentTag")]),n("li",[t._v("_parentElm")]),n("li",[t._v("_refElm")]),n("li",[t._v("render")]),n("li",[t._v("staticRenderFns")])])])])]),n("li",[t._v("stateMixin\n"),n("ul",[n("li",[t._v("在prototye上添加了:"),n("code",[t._v("$data get")]),t._v(","),n("code",[t._v("$props get")]),t._v(", "),n("code",[t._v("$set")]),t._v(", "),n("code",[t._v("$delete")])])])]),n("li",[t._v("eventsMixin\n"),n("ul",[n("li",[t._v("在prototye上添加了:"),n("code",[t._v("$on")]),t._v(" ,"),n("code",[t._v("$once")]),t._v(","),n("code",[t._v("$off")]),t._v(","),n("code",[t._v("$emit")])])])]),n("li",[t._v("lifecycleMixin\n"),n("ul",[n("li",[t._v("在prototye上添加了:"),n("code",[t._v("_update")]),t._v(","),n("code",[t._v("$forceUpdate")]),t._v(","),n("code",[t._v("$destroy")])])])]),n("li",[t._v("renderMixin\n"),n("ul",[n("li",[t._v("在prototye上添加了:"),n("code",[t._v("$nextTick")]),t._v(","),n("code",[t._v("_render")]),t._v(","),n("code",[t._v("_o = markOnce")]),t._v(","),n("code",[t._v("_n = toNumber")]),t._v(","),n("code",[t._v("_s = toString")]),t._v(","),n("code",[t._v("_l = renderList")]),t._v(","),n("code",[t._v("_t = renderSlot")]),t._v(","),n("code",[t._v("_q = looseEqual")]),t._v(","),n("code",[t._v("_i = looseIndexOf")]),t._v(","),n("code",[t._v("_m = renderStatic")]),t._v(","),n("code",[t._v("_f = resolveFilter")]),t._v(","),n("code",[t._v("_k = checkKeyCodes")]),t._v(","),n("code",[t._v("_b = bindObjectProps")]),t._v(","),n("code",[t._v("_v = createTextVNode")]),t._v(","),n("code",[t._v("_e = createEmptyVNode")]),t._v(","),n("code",[t._v("_u = resolveScopedSlots")]),t._v(","),n("code",[t._v("_g = bindObjectListeners")])])])])])])]),n("h2",{attrs:{id:"vue对象的实例化-new-vue"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#vue对象的实例化-new-vue","aria-hidden":"true"}},[t._v("#")]),t._v(" Vue对象的实例化 new Vue()")]),n("ul",[n("li",[t._v("从[Vue源码阅读()]已经可以知道Vue这个类是如何构造而来,但是Vue核心的响应式系统并未涉及,此文记录Vue源码阅读中对Vue响应式系统的理解")])]),n("p",[t._v("初始化一个简单的Vue对象包含两个data属性和一个计算属性")]),n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token function"}},[t._v("Vue")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   "),n("span",{attrs:{class:"token function"}},[t._v("data")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      a"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      b"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token number"}},[t._v("2")]),t._v("\n   "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n   computed"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),n("span",{attrs:{class:"token function"}},[t._v("c")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n         "),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("this")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("a"),n("span",{attrs:{class:"token operator"}},[t._v("+")]),n("span",{attrs:{class:"token keyword"}},[t._v("this")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("b"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n   "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),n("p",[t._v("Vue的构造函数")]),n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("Vue")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("process"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token constant"}},[t._v("NODE_ENV")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'production'")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n    "),n("span",{attrs:{class:"token operator"}},[t._v("!")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token keyword"}},[t._v("this")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("instanceof")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("Vue")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{attrs:{class:"token function"}},[t._v("warn")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v("'Vue is a constructor and should be called with the `new` keyword'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("this")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("_init")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),n("p",[n("em",[n("strong",[t._v("_init方法在init.js的initMixin方法中绑定到Vue的prototype上")])])]),n("h2",{attrs:{id:"实例化的参数-options"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#实例化的参数-options","aria-hidden":"true"}},[t._v("#")]),t._v(" 实例化的参数 Options")]),n("p",[t._v("我们所传入Vue()构造函数方法的参数(即options),通过一系列策略处理得到了最后的实例\n从上面的构造函数可以知道,实例化最核心的方法就是_init()方法.")]),n("p",[t._v("init方法中,最核心的几个步骤概括如下")]),n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options "),n("span",{attrs:{class:"token operator"}},[t._v("&&")]),t._v(" options"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_isComponent"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{attrs:{class:"token comment"}},[t._v("// optimize internal component instantiation")]),t._v("\n  "),n("span",{attrs:{class:"token comment"}},[t._v("// since dynamic options merging is pretty slow, and none of the")]),t._v("\n  "),n("span",{attrs:{class:"token comment"}},[t._v("// internal component options needs special treatment.")]),t._v("\n  "),n("span",{attrs:{class:"token function"}},[t._v("initInternalComponent")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" options"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  vm"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$options "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("mergeOptions")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),n("span",{attrs:{class:"token function"}},[t._v("resolveConstructorOptions")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("constructor"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    options "),n("span",{attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    vm\n  "),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),n("h2",{attrs:{id:"初始化函数-this-init"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#初始化函数-this-init","aria-hidden":"true"}},[t._v("#")]),t._v(" 初始化函数 this._init()")]),n("p",[t._v("在我们的例子中因为我们实例化的并不是一个组件,所以走的mergeOptions方法,通过策略合并Options,\n策略中针对不同的属性有"),n("code",[t._v("不同的处理策略")]),t._v(",大致包含如下")]),n("ul",[n("li",[t._v("el,propsData,使用defaultStrat")]),n("li",[t._v("data (稍复杂,不展开)")]),n("li",[t._v("watch,watcher不合并所以处理成对象包含数组{[],[]},parentVal在前")]),n("li",[t._v("methods,props,inject,computed 直接合并子覆盖父")]),n("li",[t._v("provide mergeDataOrFn")])]),n("p",[t._v("同时通过遍历"),n("code",[t._v("ASSET_TYPES")]),t._v("\n添加了component,directive,filter的策略"),n("code",[t._v("mergeAssets")])]),n("p",[t._v("也遍历了"),n("code",[t._v("LIFECYCLE_HOOKS")]),t._v("\n添加了所有与生命周期函数相关的钩子的策略"),n("code",[t._v("mergeHook")])]),n("p",[t._v("init 过程中为vm实例添加了")]),n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("vm"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_renderProxy "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" vm\nvm"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_self "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" vm\n")])]),n("p",[t._v("并且经过多个方法处理,如下:")]),n("p",[t._v("添加生命周期相关属性")]),n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token function"}},[t._v("initLifecycle")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),n("p",[t._v("为实例添加了_parentListeners的事件监听")]),n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token function"}},[t._v("initEvents")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),n("p",[t._v("主要挂载createElement方法\n"),n("code",[t._v("_vnode")]),t._v(","),n("code",[t._v("_staticTrees")]),t._v(","),n("code",[t._v("$slots")]),t._v(","),n("code",[t._v("$scopedSlots")]),t._v(","),n("code",[t._v("_c")]),t._v(","),n("code",[t._v("$createElement")]),t._v("\n绑定了"),n("code",[t._v("_c")]),t._v(","),n("code",[t._v("createElement")]),t._v("方法到实例上,定义了"),n("code",[t._v("$attrs")]),t._v(","),n("code",[t._v("$listeners")]),t._v("等属性")]),n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token function"}},[t._v("initRender")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),n("div",{staticClass:"warning custom-block"},[n("p",{staticClass:"custom-block-title"},[t._v("注意")]),n("p",[n("strong",[t._v("在render之后调用了生命周期钩子"),n("code",[t._v("beforeCreate")])])])]),n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token function"}},[t._v("callHook")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'beforeCreate'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token function"}},[t._v("initInjections")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// resolve injections before data/props")]),t._v("\n")])]),n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token comment"}},[t._v("//对props建立reactive property")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("//将options绑定到vm实例上 包括 Props Methods Data Computed Watch")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("//proxy 代理options上的属性到实例上,并对属性的get,set做了一次劫持")]),t._v("\n"),n("span",{attrs:{class:"token function"}},[t._v("initState")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token function"}},[t._v("initProvide")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// resolve provide after data/props")]),t._v("\n")])]),n("div",{staticClass:"warning custom-block"},[n("p",{staticClass:"custom-block-title"},[t._v("注意")]),n("p",[n("strong",[t._v("最后调用了生命周期钩子"),n("code",[t._v("created")])])])]),n("div",{staticClass:"tip custom-block"},[n("p",{staticClass:"custom-block-title"},[t._v("划重点")]),n("p",[t._v("因为在created之前并没没有挂载"),n("code",[t._v("Dom($mount)")]),t._v(",所以此时"),n("code",[t._v("$el")]),t._v("属性并不可见")])]),n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token function"}},[t._v("callHook")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'created'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),n("p",[t._v("最后")]),n("p",[t._v("在runtime/index.js中挂载了$mount")]),n("p",[t._v("query来解析模板 from ‘web/util/index’")]),n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token comment"}},[t._v("// mountComponent  from 'core/instance/lifecycle'")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$options"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("el"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    vm"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("$mount")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$options"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("el"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),n("div",{staticClass:"tip custom-block"},[n("p",{staticClass:"custom-block-title"},[t._v("划重点")]),n("p",[t._v("这里说明了为什么如果不传el的话 就需要手动去执行$mount来挂载元素")])]),n("p",[t._v("到此,初始化的大体流程基本上就是这样子了.关于其中一些方法的细节问题在后面的篇幅讨论")])])}],!1,null,null,null);s.default=e.exports}}]);